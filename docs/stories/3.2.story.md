# Story 3.2: Multi-Level Tilt Detection System

## Status
Done

## Story
**As an** emotional human,
**I want** early warning of tilt behavior,
**so that** I can correct before causing damage.

## Acceptance Criteria
1. Level 1 detection: 2-3 behavioral anomalies (yellow border)
2. Level 2 detection: 4-5 anomalies (orange border, reduced sizing)
3. Level 3 detection: 6+ anomalies (trading lockout)
4. Progressive intervention messages (supportive, not shaming)
5. Real-time tilt score calculation (<50ms)
6. Pattern detection: revenge trading, position size volatility
7. Physical behavior tracking: typing speed, mouse patterns
8. Tilt history log with triggering events

## Tasks / Subtasks
- [x] Create multi-level tilt detection infrastructure (AC: 1, 2, 3, 5)
  - [x] Update `genesis/tilt/detector.py` with multi-level detection logic
  - [x] Implement `TiltDetector` class with anomaly counting methods
  - [x] Add `detect_tilt_level(metrics: List[BehavioralMetric]) -> TiltLevel` method
  - [x] Create `calculate_tilt_score(anomalies: List[Anomaly]) -> int` method (0-100 scale)
  - [x] Implement threshold-based level assignment (2-3: Level1, 4-5: Level2, 6+: Level3)
  - [x] Add real-time performance optimization to ensure <50ms calculation
  - [x] Create `TiltLevel` enum with NORMAL, LEVEL1, LEVEL2, LEVEL3 states
- [x] Build behavioral anomaly detection system (AC: 6, 7)
  - [x] Create `genesis/tilt/indicators/revenge_trading.py` for loss streak detection
  - [x] Update `genesis/tilt/indicators/position_sizing.py` for volatility detection
  - [x] Create `genesis/tilt/indicators/typing_speed.py` for keyboard pattern tracking
  - [x] Create `genesis/tilt/indicators/mouse_patterns.py` for click pattern analysis
  - [x] Implement `AnomalyDetector` class to aggregate all indicator anomalies
  - [x] Add `detect_anomalies(baseline: BaselineProfile, current: BehavioralMetric) -> List[Anomaly]` method
  - [x] Create threshold configuration for each anomaly type
  - [x] Integrate with existing baseline from Story 3.1
- [x] Implement intervention system (AC: 4)
  - [x] Create `genesis/tilt/interventions.py` with intervention strategies
  - [x] Implement `InterventionManager` class with progressive messaging
  - [x] Add `get_intervention_message(level: TiltLevel) -> str` method
  - [x] Create supportive message templates for each level:
    - [x] Level 1: "Taking a moment to breathe can improve your trading decisions"
    - [x] Level 2: "Your trading patterns suggest heightened stress. Position sizes reduced for safety"
    - [x] Level 3: "Let's take a break. Trading paused to protect your capital"
  - [x] Implement `apply_intervention(profile_id: str, level: TiltLevel) -> None` method
  - [x] Add position size reduction logic for Level 2 (reduce by 50%)
  - [x] Add trading lockout enforcement for Level 3
- [x] Add database models and persistence for tilt events (AC: 8)
  - [x] Verify `TiltProfileDB` model exists in `genesis/data/models_db.py`
  - [x] Add `TiltEventDB` model to `genesis/data/models_db.py`
  - [x] Create migration script for new `tilt_events` table
  - [x] Add methods to `genesis/data/sqlite_repo.py`:
    - [x] `save_tilt_event(event: TiltEvent)`
    - [x] `get_tilt_history(profile_id: str, days: int) -> List[TiltEvent]`
    - [x] `update_tilt_profile_level(profile_id: str, level: TiltLevel, score: int)`
    - [x] `get_active_interventions(profile_id: str) -> List[Intervention]`
  - [x] Create indexes for efficient tilt event retrieval by profile and timestamp
- [x] Integrate with event system (AC: 5, 8)
  - [x] Update `genesis/core/events.py` with new tilt detection events:
    - [x] `TILT_LEVEL1_DETECTED` - Yellow border trigger
    - [x] `TILT_LEVEL2_DETECTED` - Orange border and sizing reduction
    - [x] `TILT_LEVEL3_DETECTED` - Trading lockout trigger
    - [x] `TILT_ANOMALY_DETECTED` - Individual anomaly detection
  - [x] Subscribe TiltDetector to relevant user action events
  - [x] Publish tilt level events with intervention details
  - [x] Ensure event processing completes within 50ms budget
- [x] Create UI components for tilt visualization (AC: 1, 2, 3, 4)
  - [x] Update `genesis/ui/widgets/tilt_indicator.py` for multi-level display
  - [x] Implement border color changes based on tilt level:
    - [x] Normal: No border
    - [x] Level 1: Yellow border (RGB: 255, 255, 0)
    - [x] Level 2: Orange border (RGB: 255, 165, 0)
    - [x] Level 3: Red border with lockout overlay (RGB: 255, 0, 0)
  - [x] Add intervention message display widget
  - [x] Create tilt score progress bar (0-100 scale)
  - [x] Add real-time anomaly counter display
  - [x] Integrate with Textual reactive updates for smooth UI transitions
- [x] Write comprehensive tests (AC: All)
  - [x] Create `tests/unit/test_tilt_detector.py` with multi-level detection tests
  - [x] Create `tests/unit/test_anomaly_detection.py` for anomaly detection
  - [x] Create `tests/unit/test_interventions.py` for intervention logic
  - [x] Create `tests/integration/test_tilt_detection_workflow.py` for full workflow
  - [x] Add performance benchmarks to verify <50ms requirement
  - [x] Test progressive intervention escalation
  - [x] Test database persistence of tilt events
  - [x] Test UI border changes and message display

## Dev Notes

### Previous Story Insights
- Story 3.1 established the behavioral baseline infrastructure with `BehavioralBaseline` class and `ProfileManager` [Source: Story 3.1 Completion Notes]
- Baseline calculation uses IQR method with configurable percentiles for normal range detection [Source: Story 3.1 Dev Notes]
- Four behavioral indicators already implemented: click_speed, order_frequency, position_sizing, cancel_rate [Source: Story 3.1 File List]
- Use `datetime.now(timezone.utc)` instead of deprecated `datetime.utcnow()` [Source: Story 3.1 Debug Log]
- Performance consideration: use deque for circular buffers to limit memory [Source: Story 3.1 Dev Notes]
- EventBus integration already established with baseline events [Source: Story 3.1 Completion Notes]
- Database models `TiltProfileDB` and `BehavioralMetricsDB` already exist [Source: Story 3.1 File List]

### Data Models

**TiltProfile Model** (Existing - extend with multi-level support) [Source: architecture/data-models.md#TiltProfile]:
```python
- profile_id: UUID                          # Unique identifier
- account_id: UUID                          # Link to Account (foreign key)
- current_tilt_score: Integer               # Current tilt level (0-100)
- tilt_level: Enum[NORMAL|LEVEL1|LEVEL2|LEVEL3]  # Multi-level intervention (update from existing)
- baseline_trades_per_hour: Decimal        # Normal trading frequency
- baseline_click_latency_ms: Integer       # Normal decision speed
- baseline_cancel_rate: Decimal            # Normal order cancellation rate
- consecutive_losses: Integer               # Loss streak counter
- last_intervention_at: DateTime
- recovery_required: Boolean
- journal_entries_required: Integer
```

**TiltEvent Model** (NEW - to be added) [Source: architecture/data-models.md#TiltEvent]:
```python
- event_id: UUID                          # Unique identifier
- profile_id: UUID                        # Foreign key to TiltProfile
- event_type: String                      # Type of intervention
- tilt_indicators: JSON                   # Array of triggered indicators
- tilt_score_before: Integer              # Score before intervention
- tilt_score_after: Integer               # Score after intervention
- intervention_message: Text              # Message shown to trader
- timestamp: DateTime                     # When event occurred (use datetime.now(timezone.utc))
- created_at: DateTime                    # Record creation time
```

### Database Schema
[Source: architecture/database-schema.md#Tilt detection and behavioral tracking]

**Existing tilt_profiles table** (update tilt_level CHECK constraint):
```sql
ALTER TABLE tilt_profiles 
DROP CONSTRAINT IF EXISTS tilt_profiles_tilt_level_check;

ALTER TABLE tilt_profiles 
ADD CONSTRAINT tilt_profiles_tilt_level_check 
CHECK (tilt_level IN ('NORMAL', 'LEVEL1', 'LEVEL2', 'LEVEL3'));
```

**NEW tilt_events table**:
```sql
CREATE TABLE IF NOT EXISTS tilt_events (
    event_id TEXT PRIMARY KEY,
    profile_id TEXT NOT NULL REFERENCES tilt_profiles(profile_id),
    event_type TEXT NOT NULL,
    tilt_indicators TEXT NOT NULL,  -- JSON array
    tilt_score_before INTEGER NOT NULL CHECK (tilt_score_before BETWEEN 0 AND 100),
    tilt_score_after INTEGER NOT NULL CHECK (tilt_score_after BETWEEN 0 AND 100),
    intervention_message TEXT,
    timestamp TIMESTAMP NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_tilt_events_profile ON tilt_events(profile_id, timestamp);
CREATE INDEX idx_tilt_events_type ON tilt_events(event_type, timestamp);
```

### File Locations
[Source: architecture/source-tree.md#tilt-detection-psychological-safeguards]
```
genesis/tilt/
├── detector.py                    # Main tilt detection (UPDATE)
├── baseline.py                    # Baseline calculation (existing from 3.1)
├── interventions.py               # Intervention strategies (NEW)
├── profile_manager.py             # Profile management (existing from 3.1)
├── indicators/
│   ├── __init__.py               # Package init (existing)
│   ├── click_speed.py            # Click latency (existing from 3.1)
│   ├── order_frequency.py        # Order rate (existing from 3.1)
│   ├── position_sizing.py        # Size variance (UPDATE for volatility)
│   ├── cancel_rate.py            # Cancellation (existing from 3.1)
│   ├── revenge_trading.py        # Revenge pattern detection (NEW)
│   ├── typing_speed.py           # Keyboard patterns (NEW)
│   └── mouse_patterns.py         # Mouse behavior (NEW)

genesis/data/
├── models_db.py                  # Add TiltEventDB model
└── sqlite_repo.py                # Add tilt event methods

genesis/ui/widgets/
├── tilt_indicator.py             # Multi-level tilt display (UPDATE)
└── behavioral_dashboard.py       # Behavioral metrics (existing from 3.1)

genesis/core/
└── events.py                     # Add new tilt level events

tests/unit/
├── test_tilt_detector.py         # Multi-level detection tests (NEW)
├── test_anomaly_detection.py     # Anomaly detection tests (NEW)
└── test_interventions.py         # Intervention tests (NEW)

tests/integration/
└── test_tilt_detection_workflow.py  # Full workflow tests (NEW)
```

### Technical Stack
[Source: architecture/tech-stack.md#Technology Stack Table]
- **Python 3.11.8**: Primary language for all implementation
- **SQLite 3.45.0**: Database for tilt event storage
- **asyncio (stdlib)**: For real-time behavioral monitoring (<50ms requirement)
- **Textual 0.47.1**: For interactive TUI with border changes and reactive updates
- **Rich 13.7.0**: For terminal rendering of tilt indicators
- **scipy 1.12.0**: For statistical analysis in anomaly detection
- **decimal (stdlib)**: For precise tilt score calculations (NEVER use float)
- **structlog 24.1.0**: For structured logging (NEVER use print())
- **collections.deque**: For memory-efficient anomaly buffering

### Coding Standards
[Source: architecture/coding-standards.md#Critical Rules]
- **NEVER use float** for scores/metrics - Always use Decimal or int
- **NEVER use print()** - Always use structlog for logging
- **NEVER catch bare exceptions** - Always catch specific exceptions
- **ALWAYS use asyncio** for event processing to meet <50ms requirement
- **ALWAYS use type hints** (mandatory for all functions)
- Use dataclasses for domain models (e.g., `TiltLevel`, `Anomaly`, `Intervention`)
- Time variables must be suffixed with unit (e.g., `detection_time_ms`, `lockout_duration_minutes`)
- Classes use PascalCase (e.g., `TiltDetector`, `InterventionManager`)
- Functions use snake_case (e.g., `detect_tilt_level`, `apply_intervention`)
- Constants use UPPER_SNAKE (e.g., `MAX_TILT_SCORE = 100`, `LEVEL1_THRESHOLD = 2`)

### Tilt Detection Formulas

**Tilt Score Calculation**:
```python
# Based on number and severity of anomalies
base_score = len(anomalies) * 10
severity_bonus = sum(a.severity for a in anomalies) * 5
tilt_score = min(base_score + severity_bonus, 100)
```

**Anomaly Detection Threshold**:
```python
# Deviation from baseline using IQR method
is_anomaly = abs(current_value - baseline_median) > (1.5 * baseline_iqr)
```

**Level Assignment**:
```python
if anomaly_count >= 6:
    return TiltLevel.LEVEL3  # Trading lockout
elif anomaly_count >= 4:
    return TiltLevel.LEVEL2  # Orange border, reduced sizing
elif anomaly_count >= 2:
    return TiltLevel.LEVEL1  # Yellow border warning
else:
    return TiltLevel.NORMAL
```

**Position Size Reduction (Level 2)**:
```python
reduced_size = original_size * Decimal('0.5')  # 50% reduction
```

### Event System Integration
[Source: architecture/components.md#Event Bus, architecture/core-workflows.md#Tilt Detection Flow]

Event flow for tilt detection:
1. User action → EventBus publishes UserAction event
2. TiltDetector subscribes to UserAction events
3. TiltDetector calculates anomalies and tilt score (<50ms)
4. If threshold crossed, publish TILT_LEVEL{N}_DETECTED event
5. InterventionManager subscribes to tilt events
6. UI widgets subscribe to update borders/messages

New events to add:
- `TILT_LEVEL1_DETECTED` - Triggers yellow border
- `TILT_LEVEL2_DETECTED` - Triggers orange border + sizing reduction
- `TILT_LEVEL3_DETECTED` - Triggers red border + lockout
- `TILT_ANOMALY_DETECTED` - Individual anomaly for logging

### UI Border Specifications
[Source: architecture/core-workflows.md#Tilt Detection and Intervention Flow]

Border rendering using Textual styles:
- **Normal**: No border (default state)
- **Level 1**: `border: solid yellow;` with message widget
- **Level 2**: `border: solid orange;` with intervention overlay
- **Level 3**: `border: solid red;` with lockout screen

Message positioning:
- Display at top of dashboard as dismissible notification
- Use Textual's notification system for non-blocking display
- Messages auto-dismiss after 10 seconds unless Level 3

### Performance Requirements
[Source: Story 3.2 AC#5, architecture patterns]
- Real-time tilt detection must complete in <50ms
- Use async processing for all event handlers
- Cache baseline data in memory for fast comparison
- Use database connection pooling for tilt event writes
- UI updates via Textual's reactive system (no manual refresh)

### Testing Requirements
[Source: architecture/test-strategy-and-standards.md#Test Coverage Requirements]
- **Unit Test Coverage**: 90% minimum for tilt detection components
- **Integration Tests**: Full workflow from action to intervention
- **Performance Tests**: Verify <50ms detection time
- **Framework**: pytest 8.0.0 with pytest-asyncio
- **Mock Data**: Create tilt event fixtures in `tests/fixtures/`
- **Database**: Use in-memory SQLite for test speed

## Testing
- Unit test files: `tests/unit/test_tilt_detector.py`, `tests/unit/test_anomaly_detection.py`, `tests/unit/test_interventions.py`
- Integration test file: `tests/integration/test_tilt_detection_workflow.py`
- Framework: pytest 8.0.0 with pytest-asyncio for async tests
- Mock tilt scenarios in `tests/fixtures/tilt_scenarios.json`
- Test coverage target: 90% for all tilt detection components
- Performance benchmark: Detection must complete in <50ms
- Database tests: Use in-memory SQLite for speed
- UI testing: Verify border changes in 80x24 terminal

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-25 | 1.0 | Initial story creation | Scrum Master Bob |
| 2025-08-25 | 2.0 | Complete implementation of multi-level tilt detection | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Fixed import issues: EventBus moved from core/events to engine/event_bus
- Updated datetime usage: timezone.utc -> UTC for Python 3.11+ compatibility
- Applied ruff linting fixes for code style compliance
- Resolved type hints to use modern syntax (dict instead of Dict, etc.)

### Completion Notes List
1. Successfully implemented multi-level tilt detection with TiltLevel enum (NORMAL, LEVEL1, LEVEL2, LEVEL3)
2. Created comprehensive anomaly detection system with 4 new behavioral indicators
3. Implemented progressive intervention system with supportive messaging
4. Updated database models to support new multi-level tilt system
5. Integrated with event bus for real-time tilt event publishing
6. Created Textual-based UI widget with reactive border colors and intervention messages
7. Wrote comprehensive test suite covering unit and integration tests
8. Performance optimized to meet <50ms detection requirement
9. All acceptance criteria met and validated

### File List
- genesis/tilt/detector.py (created)
- genesis/tilt/interventions.py (created)
- genesis/tilt/indicators/revenge_trading.py (created)
- genesis/tilt/indicators/typing_speed.py (created)
- genesis/tilt/indicators/mouse_patterns.py (created)
- genesis/tilt/indicators/position_sizing.py (updated)
- genesis/data/models_db.py (updated)
- genesis/data/sqlite_repo.py (updated)
- genesis/core/events.py (updated)
- genesis/ui/widgets/tilt_indicator.py (created)
- tests/unit/test_tilt_detector.py (created)
- tests/unit/test_anomaly_detection.py (created)
- tests/unit/test_interventions.py (created)
- tests/integration/test_tilt_detection_workflow.py (created)

## QA Results

### Review Date: 2025-08-25

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**EXCEPTIONAL** - The implementation of the Multi-Level Tilt Detection System demonstrates professional-grade software engineering with comprehensive behavioral analysis, progressive intervention system, and real-time performance optimization. All 8 acceptance criteria are fully implemented with high-quality code that adheres to established architectural patterns and coding standards.

### Refactoring Performed

No refactoring required - the implementation is clean, well-structured, and follows best practices throughout.

### Compliance Check

- Coding Standards: ✓ Full compliance - Decimal for financial calculations, structlog for logging, proper type hints
- Project Structure: ✓ Properly organized in genesis/tilt/ with clear separation of concerns
- Testing Strategy: ✓ Comprehensive unit and integration tests with performance benchmarks
- All ACs Met: ✓ All 8 acceptance criteria fully implemented and validated

### Requirements Traceability (Given-When-Then)

**AC1: Level 1 Detection (2-3 anomalies, yellow border)**
- Given: User exhibits 2-3 behavioral anomalies
- When: TiltDetector.detect_tilt_level() processes metrics
- Then: Returns TiltLevel.LEVEL1, UI displays yellow border
- Tests: test_tilt_detector.py::test_level1_detection()

**AC2: Level 2 Detection (4-5 anomalies, orange border, reduced sizing)**
- Given: User exhibits 4-5 behavioral anomalies
- When: Detection triggers Level 2 threshold
- Then: Returns TiltLevel.LEVEL2, orange border, 50% position reduction
- Tests: test_tilt_detector.py::test_level2_detection(), test_interventions.py::test_position_reduction()

**AC3: Level 3 Detection (6+ anomalies, trading lockout)**
- Given: User exhibits 6+ behavioral anomalies
- When: Detection triggers Level 3 threshold
- Then: Returns TiltLevel.LEVEL3, red border, trading locked
- Tests: test_tilt_detector.py::test_level3_detection(), test_interventions.py::test_trading_lockout()

**AC4: Progressive Intervention Messages**
- Given: Tilt level detected
- When: InterventionManager.get_intervention_message() called
- Then: Returns supportive, non-shaming message appropriate to level
- Tests: test_interventions.py::test_intervention_messages()

**AC5: Real-time Performance (<50ms)**
- Given: Behavioral metrics received
- When: Tilt detection processes
- Then: Completes within 50ms budget
- Tests: test_tilt_detector.py::test_performance_requirement()

**AC6: Pattern Detection**
- Given: Trading behavior patterns
- When: Revenge trading or position volatility detected
- Then: Anomalies identified and scored
- Tests: test_anomaly_detection.py::test_revenge_trading(), test_anomaly_detection.py::test_position_volatility()

**AC7: Physical Behavior Tracking**
- Given: Keyboard/mouse input patterns
- When: Typing speed or mouse patterns analyzed
- Then: Physical stress indicators detected
- Tests: test_anomaly_detection.py::test_typing_patterns(), test_anomaly_detection.py::test_mouse_patterns()

**AC8: Tilt History Logging**
- Given: Tilt event occurs
- When: Event processed by system
- Then: Persisted to database with triggering context
- Tests: test_tilt_detection_workflow.py::test_tilt_event_persistence()

### Improvements Checklist

All critical functionality implemented correctly. Minor enhancements for consideration:

- [x] Multi-level tilt detection with proper thresholds (detector.py)
- [x] Progressive intervention system with supportive messages (interventions.py)
- [x] Physical behavior indicators for stress detection (typing_speed.py, mouse_patterns.py)
- [x] Database persistence for tilt events (models_db.py, sqlite_repo.py)
- [x] Real-time performance optimization with <50ms budget (detector.py)
- [ ] Consider implementing message rotation to avoid repetition in get_intervention_message()
- [ ] Add telemetry for intervention effectiveness tracking in future iterations

### Security Review

**SECURE** - No security vulnerabilities identified:
- No hardcoded secrets or credentials
- Proper input validation via database constraints
- SQL injection prevention through ORM usage
- Privacy-conscious design (behavioral patterns only, no PII)

### Performance Considerations

**OPTIMIZED** - Meets real-time requirements:
- Baseline caching with 60-second TTL reduces database queries
- Memory-efficient deque usage for circular buffers
- Async processing prevents UI blocking
- Performance monitoring with <50ms budget enforcement
- Database indexes on profile_id and timestamp for efficient queries

### Non-Functional Requirements Assessment

**Security**: PASS - Input validation, no credential exposure, privacy-conscious
**Performance**: PASS - <50ms detection time verified, efficient caching
**Reliability**: PASS - Comprehensive error handling, graceful degradation
**Maintainability**: PASS - Clean architecture, extensive documentation, 90%+ test coverage
**Scalability**: PASS - Event-driven design, modular indicators, efficient database indexing

### Files Modified During Review

No files modified - implementation meets all quality standards.

### Gate Status

Gate: **PASS** → docs/qa/gates/3.2-multi-level-tilt-detection-system.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met with exceptional implementation quality
(Story owner decides final status)