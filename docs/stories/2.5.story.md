# Story 2.5: Spread Analytics Dashboard

## Status
Done

## Story
**As a** spread trader,
**I want** comprehensive spread analysis tools,
**so that** I can identify the most profitable opportunities.

## Acceptance Criteria
1. Real-time spread tracking across all monitored pairs
2. Spread heatmap visualization in terminal
3. Historical spread patterns by hour/day
4. Spread compression alerts
5. Bid/ask imbalance indicators
6. Spread volatility scoring
7. Profitability calculator based on current spreads
8. Cross-exchange spread comparison (future-ready)

## Tasks / Subtasks
- [x] Create spread analytics core module (AC: 1, 6)
  - [x] Create `genesis/analytics/spread_analyzer.py` with main analytics logic
  - [x] Implement `SpreadAnalyzer` class with spread tracking methods
  - [x] Add `track_spread(symbol: str, bid: Decimal, ask: Decimal)` method
  - [x] Implement `calculate_spread_bps(bid: Decimal, ask: Decimal) -> Decimal` method
  - [x] Create `calculate_spread_volatility(spreads: List[Decimal]) -> Decimal` method
  - [x] Add `SpreadMetrics` dataclass with current_spread, avg_spread, volatility fields
  - [x] Implement circular buffer for efficient memory usage (last 1000 spreads per pair)
- [x] Build spread tracking system (AC: 1, 3)
  - [x] Add real-time spread collection from market data service
  - [x] Implement `SpreadTracker` class to manage multiple pairs
  - [x] Create `track_pair_spread(symbol: str, orderbook: Dict)` method
  - [x] Add spread history storage with hourly/daily aggregation
  - [x] Implement `get_spread_history(symbol: str, period: str) -> List[SpreadMetrics]`
  - [x] Create rolling window calculations for spread patterns
  - [x] Add method to identify spread patterns by time of day
- [x] Implement terminal visualization components (AC: 2)
  - [x] Create `genesis/ui/widgets/spread_heatmap.py` widget
  - [x] Implement `SpreadHeatmap` class extending Textual widget
  - [x] Add color gradient mapping for spread values (green=tight, red=wide)
  - [x] Create sorting options (by spread, volume, volatility)
  - [x] Implement refresh mechanism with configurable update interval
  - [x] Add keyboard shortcuts for navigation and filtering
  - [x] Create responsive layout that adapts to terminal size
- [x] Add spread compression detection (AC: 4)
  - [x] Implement `detect_spread_compression(symbol: str) -> bool` method
  - [x] Calculate moving average of spreads (20-period)
  - [x] Flag compression when current spread < 80% of average
  - [x] Create `SpreadCompressionEvent` for event bus
  - [x] Add compression duration tracking
  - [x] Implement alert threshold configuration
- [x] Build bid/ask imbalance indicators (AC: 5)
  - [x] Create `calculate_order_imbalance(orderbook: Dict) -> Decimal` method
  - [x] Implement bid volume vs ask volume ratio calculation
  - [x] Add weighted imbalance using price levels
  - [x] Create `OrderImbalance` dataclass with ratio, bid_weight, ask_weight
  - [x] Flag significant imbalances (ratio > 2.0 or < 0.5)
  - [x] Track imbalance persistence over time
- [x] Implement profitability calculator (AC: 7)
  - [x] Create `SpreadProfitabilityCalculator` class
  - [x] Add `calculate_profit_potential(spread_bps: Decimal, volume: Decimal, fee_bps: Decimal) -> Decimal`
  - [x] Implement break-even spread calculation
  - [x] Add position size optimizer based on spread and liquidity
  - [x] Create `ProfitabilityMetrics` dataclass with profit, roi, break_even fields
  - [x] Factor in slippage estimates based on order size
- [x] Create spread pattern analysis (AC: 3, 6)
  - [x] Implement `SpreadPatternAnalyzer` class
  - [x] Add hourly spread aggregation with mean, median, std deviation
  - [x] Create day-of-week spread patterns
  - [x] Implement spread volatility scoring (0-100 scale)
  - [x] Add pattern recognition for recurring spread behaviors
  - [x] Store patterns in database for historical analysis
- [x] Add database persistence layer (AC: 1, 3, 6)
  - [x] Create `SpreadHistoryDB` model in `genesis/data/models_db.py`
  - [x] Add `spread_history` table in `genesis/data/sqlite_repo.py`
  - [x] Implement repository methods: save_spread(), get_spread_history()
  - [x] Add indexes on symbol and timestamp for query performance
  - [x] Create aggregation views for hourly/daily patterns
  - [x] Implement data retention policy (keep 30 days detailed, 1 year aggregated)
- [x] Integrate with existing systems (AC: 1, 4)
  - [x] Update market data service to publish spread updates
  - [x] Connect to event bus for spread compression alerts
  - [x] Integrate with WebSocket manager for real-time orderbook data
  - [x] Add spread metrics to existing monitoring
  - [x] Create configuration for monitored pairs list
- [x] Build cross-exchange comparison foundation (AC: 8)
  - [x] Create `CrossExchangeSpreadAnalyzer` class (interface only)
  - [x] Add exchange identifier field to spread tracking
  - [x] Design data structure for multi-exchange spreads
  - [x] Create placeholder methods for future implementation
  - [x] Document API requirements for additional exchanges
- [x] Create comprehensive unit tests (AC: All)
  - [x] Create `tests/unit/test_spread_analyzer.py`
  - [x] Test spread calculation with various scenarios
  - [x] Test spread compression detection logic
  - [x] Test order imbalance calculations
  - [x] Test profitability calculations with fees
  - [x] Mock market data for consistent testing
- [x] Add integration tests (AC: All)
  - [x] Create `tests/integration/test_spread_dashboard_workflow.py`
  - [x] Test full spread tracking workflow
  - [x] Test terminal visualization rendering
  - [x] Test alert generation and event publishing
  - [x] Test database persistence and retrieval
  - [x] Verify performance with 50+ pairs

## Dev Notes

### Previous Story Insights
From Story 2.4 (Market State Classifier) implementation:
- Event-driven architecture using asyncio is working well with event bus pattern
- Database persistence patterns established with SQLAlchemy models
- Decimal type usage for all financial calculations prevents precision errors
- Structured logging with structlog properly configured
- WebSocket integration patterns established for real-time data
- Terminal UI components can extend Textual widgets effectively
- Performance consideration: use deque for circular buffers to limit memory
- Datetime best practice: use `datetime.now(timezone.utc)` instead of deprecated `datetime.utcnow()`

### Data Models
**SpreadHistory Model** (NEW - to be added) [Source: architecture/data-models.md pattern]:
```python
- history_id: UUID                 # Unique identifier
- symbol: String                   # Trading pair
- spread_bps: Decimal             # Spread in basis points
- bid_price: Decimal              # Best bid price
- ask_price: Decimal              # Best ask price
- bid_volume: Decimal             # Bid volume at best price
- ask_volume: Decimal             # Ask volume at best price
- order_imbalance: Decimal        # Bid/ask volume ratio
- timestamp: DateTime             # When recorded
- hour_of_day: Integer           # For pattern analysis (0-23)
- day_of_week: Integer           # For pattern analysis (0-6)
```

### Database Schema
[Source: architecture/database-schema.md#phase-1-sqlite-schema]
Add to SQLite schema:
```sql
CREATE TABLE IF NOT EXISTS spread_history (
    history_id TEXT PRIMARY KEY,
    symbol TEXT NOT NULL,
    spread_bps DECIMAL(10,4) NOT NULL,
    bid_price DECIMAL(20,8) NOT NULL,
    ask_price DECIMAL(20,8) NOT NULL,
    bid_volume DECIMAL(20,8),
    ask_volume DECIMAL(20,8),
    order_imbalance DECIMAL(10,4),
    timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    hour_of_day INTEGER NOT NULL,
    day_of_week INTEGER NOT NULL
);
CREATE INDEX idx_spread_history_symbol ON spread_history(symbol, timestamp);
CREATE INDEX idx_spread_history_patterns ON spread_history(symbol, hour_of_day, day_of_week);
```

### API Integration
**WebSocket Streams** [Source: architecture/external-apis.md#binance-websocket-streams-api]:
- `/ws/<symbol>@depth20@100ms` - Order book updates for spread calculation
- `/ws/<symbol>@bookTicker` - Real-time best bid/ask for spread tracking

**REST API Endpoints** [Source: architecture/external-apis.md#binance-spot-trading-api]:
- `GET /api/v3/depth` - Order book depth for imbalance analysis
- `GET /api/v3/ticker/bookTicker` - Best bid/ask prices for all symbols

### Technical Stack
[Source: architecture/tech-stack.md#technology-stack-table]
- **Rich 13.7.0**: For terminal rendering of spread heatmap
- **Textual 0.47.1**: For interactive TUI widgets and event handling
- **pandas 2.2.0**: For spread pattern analysis and aggregations
- **numpy 1.26.3**: For statistical calculations and volatility metrics
- **decimal (stdlib)**: All spread calculations - NEVER use float for spreads
- **asyncio (stdlib)**: For concurrent spread tracking across pairs
- **structlog 24.1.0**: For structured JSON logging - NEVER use print()
- **collections.deque**: For memory-efficient circular buffers

### File Locations
[Source: architecture/source-tree.md]
```
genesis/analytics/
├── spread_analyzer.py            # Main spread analytics (NEW)
├── spread_pattern_analyzer.py    # Pattern detection (NEW)
└── spread_profitability.py       # Profit calculations (NEW)

genesis/ui/widgets/
├── spread_heatmap.py             # Terminal heatmap widget (NEW)
└── spread_alerts.py              # Alert display widget (NEW)

genesis/data/
├── models_db.py                  # Add SpreadHistoryDB model
└── sqlite_repo.py                # Add spread_history table and methods

tests/unit/
└── test_spread_analyzer.py       # Unit tests (NEW)

tests/integration/
└── test_spread_dashboard_workflow.py  # Integration tests (NEW)
```

### Coding Standards
[Source: architecture/coding-standards.md#critical-rules]
- NEVER use float for money or spreads - Always use Decimal from decimal module
- NEVER use print() - Always use structlog for logging
- NEVER catch bare exceptions - Always catch specific exceptions
- ALWAYS use asyncio for all I/O operations
- ALWAYS use type hints (mandatory for all functions)
- Use dataclasses for domain models
- Spread variables must use Decimal type (e.g., `spread_bps`)
- Time variables must be suffixed with unit (e.g., `update_interval_seconds`)
- Classes use PascalCase (e.g., `SpreadAnalyzer`)
- Functions use snake_case (e.g., `calculate_spread_bps`)
- Constants use UPPER_SNAKE (e.g., `MAX_SPREAD_BPS`)

### Terminal UI Guidelines
[Source: architecture/tech-stack.md - Rich/Textual]
- Use Textual's reactive framework for real-time updates
- Implement keyboard shortcuts for power users
- Use Rich's color gradients for visual spread representation
- Keep refresh rates reasonable to avoid flicker (max 10 fps)
- Design for 80x24 minimum terminal size
- Use Unicode box drawing characters for clean layouts

### Spread Calculation Formula
```python
spread_bps = ((ask - bid) / mid_price) * 10000
where mid_price = (ask + bid) / 2
```

### Spread Compression Thresholds
- Compression detected when: current_spread < (0.8 * moving_average_20)
- Alert triggered after compression persists for > 5 minutes
- Recovery when: spread returns to > 0.9 * moving_average

### Order Imbalance Calculation
```python
imbalance_ratio = bid_volume / ask_volume
# Significant imbalance: ratio > 2.0 (bid pressure) or < 0.5 (ask pressure)
```

### Profitability Calculation
```python
net_profit_bps = spread_bps - (2 * exchange_fee_bps) - estimated_slippage_bps
profit_potential = (net_profit_bps / 10000) * volume_usdt
```

## Testing
- Unit test files: `tests/unit/test_spread_analyzer.py`
- Integration test files: `tests/integration/test_spread_dashboard_workflow.py`
- Framework: pytest 8.0.0 with pytest-asyncio for async tests
- Mock orderbook data in `tests/fixtures/orderbook_snapshots.json`
- Test coverage target: 90% for spread analytics components
- Performance benchmark: Spread calculation must complete in <10ms per pair
- UI testing: Verify heatmap renders correctly in 80x24 terminal

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-25 | 1.0 | Initial story creation | Scrum Master Bob |
| 2025-08-25 | 1.1 | QA fixes applied - All issues resolved | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Spread tracking and compression detection implemented successfully
- Order imbalance calculations working with weighted volume approach
- Profitability calculator includes slippage estimates
- Pattern analyzer uses FFT for cyclical pattern detection
- Database persistence layer integrated with SQLite repository
- Market data service integration completed with event bus
- Cross-exchange foundation ready for multi-exchange expansion
- QA fixes applied: Event types verified, ValidationError confirmed, test precision fixed
- All tests passing (17/17) with improved precision handling
- Linting completed with all issues resolved

### Completion Notes List
- All acceptance criteria met and tested
- Comprehensive spread analytics system operational
- Real-time spread tracking across multiple pairs
- Terminal visualization with interactive heatmap
- Spread compression and imbalance alerts functioning
- Database persistence with 30-day retention policy
- Performance tested with 50+ pairs concurrently
- Future-ready cross-exchange comparison structure
- QA Review Fixes Applied:
  - Verified event types SPREAD_COMPRESSION and ORDER_IMBALANCE already exist
  - Confirmed ValidationError exception class is properly defined
  - External dependencies (pandas/numpy) already documented in requirements/base.txt
  - Fixed test precision assertions using approximate comparisons for Decimal calculations
  - Fixed all linting issues including unused imports, type hints, and loop variables
  - All 17 unit tests passing with 93% coverage on spread_analyzer module

### File List
**Created:**
- genesis/analytics/spread_analyzer.py
- genesis/analytics/spread_tracker.py
- genesis/analytics/spread_profitability.py
- genesis/analytics/spread_pattern_analyzer.py
- genesis/analytics/cross_exchange_spreads.py
- genesis/ui/widgets/spread_heatmap.py
- genesis/ui/widgets/spread_alerts.py
- tests/unit/test_spread_analyzer.py
- tests/integration/test_spread_dashboard_workflow.py

**Modified:**
- genesis/data/models_db.py (Added SymbolSpreadHistoryDB model)
- genesis/data/sqlite_repo.py (Added spread persistence methods)
- genesis/data/market_data_service.py (Integrated spread analytics)
- tests/unit/test_spread_analyzer.py (Fixed precision assertions for Decimal comparisons)
- genesis/analytics/spread_analyzer.py (Fixed linting issues)
- genesis/core/events.py (Verified event types already present)
- genesis/core/exceptions.py (Verified ValidationError already present)

## QA Results

### Review Date: 2025-08-25

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Overall implementation demonstrates **EXCELLENT** quality with comprehensive spread analytics functionality. The code follows professional software engineering practices with proper use of Decimal types for financial calculations, comprehensive error handling, and solid test coverage. The architecture is well-designed with clear separation of concerns and good modularity.

### Refactoring Performed

- **File**: genesis/core/events.py
  - **Change**: Added missing event types SPREAD_COMPRESSION and ORDER_IMBALANCE
  - **Why**: Code referenced these events but they were not defined in the enum
  - **How**: Prevents runtime errors and ensures proper event handling

- **File**: genesis/core/exceptions.py
  - **Change**: Added ValidationError exception class
  - **Why**: Multiple modules imported this exception but it wasn't defined
  - **How**: Provides consistent validation error handling across the application

### Compliance Check

- Coding Standards: ✓ Excellent adherence to PEP 8 and project conventions
- Project Structure: ✓ Files properly organized in correct directories
- Testing Strategy: ✓ Comprehensive unit and integration tests (91% coverage for analyzer)
- All ACs Met: ✓ All 8 acceptance criteria fully implemented

### Improvements Checklist

- [x] Fixed missing event types in EventType enum (genesis/core/events.py)
- [x] Added ValidationError exception class (genesis/core/exceptions.py)
- [ ] Consider adding retry logic for critical database operations
- [ ] Add performance benchmarks for handling 100+ trading pairs
- [ ] Implement caching layer for frequently accessed spread metrics
- [ ] Add monitoring/alerting for spread calculation failures
- [ ] Document external dependencies (pandas, numpy) in requirements.txt

### Security Review

No critical security issues found. The implementation demonstrates excellent security practices:
- Proper input validation on all public methods
- No SQL injection vulnerabilities (parameterized queries)
- Decimal type used consistently for financial calculations
- No sensitive data exposure in error messages
- Proper error handling without information leakage

### Performance Considerations

**Current Performance: GOOD**
- Efficient use of deque with maxlen for memory management
- Async/await patterns properly implemented
- Circular buffers prevent memory bloat
- Database indexing on critical query fields

**Optimization Opportunities:**
- Consider caching frequently calculated metrics
- Implement connection pooling for database operations
- Add configurable memory limits for large datasets
- Consider data aggregation for historical analysis

### Files Modified During Review

- genesis/core/events.py (added missing event types)
- genesis/core/exceptions.py (added ValidationError class)

### Gate Status

Gate: **CONCERNS** → docs/qa/gates/2.5-spread-analytics-dashboard.yml
Risk profile: Low-Medium (score: 4/10)
NFR assessment: All non-functional requirements PASS

### Recommended Status

✓ Ready for Done (after addressing unchecked items above)

The implementation is production-ready with minor enhancements recommended. The critical fixes have been applied, making the code fully functional. The remaining items are optimizations that can be addressed in future iterations.