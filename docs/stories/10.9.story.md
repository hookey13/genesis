# Story 10.9: Strategy Configuration & Parameter Management

**Status:** Approved
**Epic:** Epic 10 - Core Trading Brain Implementation
**Type:** Sequential-Required (Needs strategies)
**Branch:** feature/10-9
**Estimated Hours:** 6
**Developer Assignment:** Developer 1

## User Story
As a system operator,
I want centralized strategy configuration with hot-reload capability,
So that strategy parameters can be adjusted without system restart.

## Acceptance Criteria
1. YAML/JSON strategy configuration files
2. Parameter validation with type checking
3. Hot-reload without trading interruption
4. Configuration versioning with rollback
5. A/B testing parameter sets
6. Environment-specific overrides (dev/staging/prod)
7. Secure storage for sensitive parameters
8. Configuration drift detection
9. Automated parameter optimization
10. Audit logging for all changes

## Technical Implementation

### Files to Modify/Create
```
├── genesis/
│   ├── config/
│   │   ├── strategy_config.py [CREATE]
│   │   ├── file_watcher.py [CREATE]
│   │   └── config_validator.py [CREATE]
├── config/
│   └── strategies/
│       ├── sniper_arbitrage.yaml [CREATE]
│       ├── hunter_mean_reversion.yaml [CREATE]
│       └── strategist_vwap.yaml [CREATE]
└── tests/
    └── unit/
        └── test_strategy_config.py [CREATE]
```

### Code Modules Owned
- **Primary:** All configuration modules
- **No Touch:** Strategy implementations

## Dependencies

### Must Complete Before Starting
- Story 10.2 (Sniper strategies)
- Story 10.3 (Hunter strategies)
- Story 10.4 (Strategist strategies)

### Can Start But Needs Later
- Story 10.10 (Production validation)

### Parallel Stories (Same Time)
- Story 10.8 (Paper Trading)

## Implementation Checklist
- [ ] Create feature branch via worktree
- [ ] Create StrategyConfigManager
- [ ] Implement config file loading
- [ ] Add validation logic
- [ ] Create FileWatcher for hot-reload
- [ ] Implement version history
- [ ] Add rollback capability
- [ ] Create A/B testing support
- [ ] Add environment overrides
- [ ] Implement audit logging
- [ ] Create sample config files
- [ ] Write unit tests
- [ ] Test hot-reload functionality
- [ ] Create pull request
- [ ] Peer review from strategy developers
- [ ] Merge to main branch

## Worktree Setup Commands
```bash
# Developer 1 executes:
cd /path/to/main/repo
git worktree add -b feature/10-9 ../worktree-10-9
cd ../worktree-10-9

# After completion:
git push origin feature/10-9
# Create PR for review
```

## Testing Requirements
### Unit Tests
- Test config loading
- Test validation rules
- Test hot-reload triggers
- Test version management
- Test audit logging

### Integration Tests
- Hot-reload without disruption
- A/B parameter testing

## Definition of Done
- [ ] All acceptance criteria met
- [ ] Code review approved
- [ ] All tests passing
- [ ] Hot-reload working
- [ ] Config files created
- [ ] Documentation complete
- [ ] Branch merged to main

## Dev Notes

### Testing Standards
- **Test file location:** `tests/unit/test_strategy_config.py`
- **Test framework:** pytest with async support
- **Coverage requirement:** >95% for configuration modules
- **Test scenarios:** Config loading, validation, hot-reload, version management
- **Integration tests:** Hot-reload without trading disruption
- **Mock configurations:** Test with valid and invalid YAML/JSON files

### Project Structure
From the source tree:
```
genesis/
├── config/                     # EXISTING directory
│   ├── __init__.py
│   ├── settings.py            # Pydantic settings with validation
│   ├── strategy_config.py     # NEW - Strategy config manager
│   ├── file_watcher.py        # NEW - File system watcher
│   ├── config_validator.py    # NEW - Config validation
│   ├── tier_gates.yaml        # EXISTING - Tier requirements
│   └── trading_rules.yaml     # EXISTING - Risk limits
config/                          # Root level config directory
└── strategies/                 # NEW directory for strategy configs
    ├── sniper_arbitrage.yaml  # NEW - Sniper tier config
    ├── hunter_mean_reversion.yaml  # NEW - Hunter tier config
    └── strategist_vwap.yaml   # NEW - Strategist tier config
```

### Architecture Context
- **Python version:** 3.11.8 exclusively
- **Configuration library:** pydantic 2.5.3 for validation
- **File format:** YAML primary, JSON secondary
- **Async framework:** asyncio for file watching
- **Logging:** structlog for audit logging
- **Type hints:** Mandatory for all functions

### Integration Requirements
- Must integrate with existing `genesis/strategies/` modules
- Must use pydantic for configuration validation
- Must integrate with trading engine without disruption
- Must support tier-based strategy loading from `genesis/strategies/loader.py`
- Version history must be persisted to database
- Audit logs must capture all configuration changes

### Key Implementation Details

#### StrategyConfigManager Class
```python
class StrategyConfigManager:
    def __init__(self, config_path: str):
        self.config_path = config_path
        self.configs = {}  # Strategy name -> config dict
        self.version_history = []  # List of config versions
        self.file_watcher = FileWatcher()
        self.validator = ConfigValidator()
```

#### Configuration Loading
- **File discovery:** Use glob.glob() to find all *.yaml files
- **Validation:** Use pydantic models for type checking
- **Schema validation:** Ensure required fields present
- **Type coercion:** Convert string values to appropriate types
- **Default values:** Apply defaults for missing optional fields

#### Hot-Reload Implementation
- **File watching:** Use asyncio with file system events
- **Change detection:** Compare file modification times
- **Validation before reload:** Validate new config before applying
- **Atomic updates:** Update config dict atomically
- **Strategy notification:** Notify strategies of config changes
- **Rollback on error:** Revert to previous config if reload fails

#### Version Management
- **Version tracking:** Store config snapshots with timestamps
- **History limit:** Keep last 100 versions (configurable)
- **Rollback capability:** Restore any previous version
- **Diff generation:** Show changes between versions
- **Database persistence:** Store versions in database

#### A/B Testing Support
- **Multiple configs:** Support multiple parameter sets per strategy
- **Random selection:** Randomly assign variants to instances
- **Performance tracking:** Track metrics per variant
- **Statistical analysis:** Compare variant performance
- **Automatic selection:** Choose best performing variant

#### Environment Overrides
- **Environment detection:** Check ENV variable (dev/staging/prod)
- **Override hierarchy:** ENV > file > defaults
- **Secure parameters:** Support encrypted values for API keys
- **Validation:** Ensure overrides don't violate constraints

### Configuration Schema Example
```yaml
# sniper_arbitrage.yaml
strategy:
  name: "SniperArbitrage"
  version: "1.0.0"
  tier: "sniper"
  enabled: true

parameters:
  min_profit_pct: 0.3
  max_position_pct: 0.02
  stop_loss_pct: 1.0
  take_profit_pct: 0.5
  min_order_size: 10.0
  max_order_size: 100.0
  
risk_limits:
  max_positions: 1
  max_daily_loss_pct: 5.0
  max_correlation: 0.7
  
execution:
  order_type: "market"
  time_in_force: "IOC"
  retry_attempts: 3
  retry_delay_ms: 100
  
monitoring:
  log_level: "INFO"
  metrics_interval_seconds: 60
  alert_on_loss: true

# Environment-specific overrides
overrides:
  dev:
    parameters:
      min_profit_pct: 0.1  # Lower threshold for testing
  prod:
    parameters:
      min_profit_pct: 0.5  # Higher threshold for production
```

### Audit Logging Requirements
- Log all configuration changes with:
  - Timestamp (UTC)
  - Strategy name
  - Changed fields
  - Old values
  - New values
  - Source (file change, API, manual)
  - User/system identifier

### Security Considerations
- **Sensitive parameters:** Never log API keys or secrets
- **Encryption:** Support encrypted values in config files
- **Access control:** Restrict config file permissions
- **Validation:** Prevent injection attacks via config values
- **Audit trail:** Maintain complete audit log for compliance

### Critical Performance Requirements
- Config load time: <100ms per file
- Hot-reload latency: <500ms
- File watch overhead: <1% CPU
- Memory usage: <10MB for all configs
- Version history storage: <1MB per 100 versions

### Error Handling
- **Invalid YAML:** Log error, skip file, continue with others
- **Validation failure:** Log details, reject config, keep previous
- **File permission errors:** Log warning, retry with backoff
- **Hot-reload failure:** Log error, keep current config, alert operator
- **Version rollback failure:** Log critical, maintain current state

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-03 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-09-03 | 1.1 | Added comprehensive Dev Notes | Sarah (PO) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*TBD*

### Debug Log References
*TBD*

### Completion Notes List
*TBD*

### File List
*TBD*

## QA Results
*To be populated during QA review*