# Story 3.4: Micro-Behavior Analytics

## Status
Done

## Story
**As a** trader seeking self-improvement,
**I want** detailed behavioral analytics,
**so that** I can understand my emotional patterns.

## Acceptance Criteria
1. Click-to-trade latency tracking and analysis
2. Order modification frequency monitoring
3. Tab-switching pattern detection
4. "Stare time" measurement (inactivity periods)
5. Configuration change tracking
6. Session length analysis
7. Correlation between behaviors and P&L
8. Weekly behavioral report generation

## Tasks / Subtasks
- [x] Implement click-to-trade latency tracking (AC: 1)
  - [x] Create `genesis/analytics/behavioral_metrics.py` with latency tracking
  - [x] Implement `ClickLatencyTracker` class with millisecond precision timing
  - [x] Add `track_click_latency(action_type: str, latency_ms: int) -> None` method
  - [x] Create moving average calculation for baseline comparison
  - [x] Store latency data in `behavioral_metrics` table with timestamps
  - [x] Create unit tests in `tests/unit/test_behavioral_metrics.py`
- [x] Build order modification frequency monitoring (AC: 2)
  - [x] Extend `genesis/analytics/behavioral_metrics.py` with modification tracking
  - [x] Implement `OrderModificationTracker` class
  - [x] Add `track_order_modification(order_id: str, modification_type: str) -> None` method
  - [x] Calculate modification frequency per time window (5min, 30min, 1hr)
  - [x] Compare against baseline modification rates
  - [x] Add database persistence for modification events
  - [x] Create unit tests for modification tracking
- [x] Implement tab-switching pattern detection (AC: 3)
  - [x] Create `genesis/tilt/indicators/focus_patterns.py` for focus tracking
  - [x] Implement `FocusPatternDetector` class
  - [x] Add `track_window_focus(window_active: bool, duration_ms: int) -> None` method
  - [x] Calculate tab-switching frequency and patterns
  - [x] Detect rapid switching as potential tilt indicator
  - [x] Store focus events with timestamps in database
  - [x] Create unit tests in `tests/unit/test_focus_patterns.py`
- [x] Create "stare time" measurement system (AC: 4)
  - [x] Add inactivity detection to `genesis/analytics/behavioral_metrics.py`
  - [x] Implement `InactivityTracker` class
  - [x] Add `track_inactivity_period(start: datetime, end: datetime) -> None` method
  - [x] Define inactivity thresholds (no clicks/keys for 30+ seconds)
  - [x] Correlate stare time with market conditions
  - [x] Store inactivity periods in database
  - [x] Create unit tests for inactivity tracking
- [x] Build configuration change tracking (AC: 5)
  - [x] Create `genesis/analytics/config_tracker.py` for settings monitoring
  - [x] Implement `ConfigurationChangeTracker` class
  - [x] Add `track_config_change(setting: str, old_value: Any, new_value: Any) -> None` method
  - [x] Log all configuration changes with timestamps
  - [x] Detect frequent configuration changes as tilt indicator
  - [x] Store configuration history in `config_changes` table
  - [x] Create unit tests in `tests/unit/test_config_tracker.py`
- [x] Implement session length analysis (AC: 6)
  - [x] Extend `genesis/analytics/behavioral_metrics.py` with session tracking
  - [x] Implement `SessionAnalyzer` class
  - [x] Add `analyze_session_duration(session_id: str) -> SessionMetrics` method
  - [x] Calculate average session length over time
  - [x] Detect unusually long sessions (fatigue indicator)
  - [x] Compare session performance by duration
  - [x] Create unit tests for session analysis
- [x] Create behavior-P&L correlation system (AC: 7)
  - [x] Create `genesis/analytics/behavior_correlation.py` for correlation analysis
  - [x] Implement `BehaviorPnLCorrelator` class
  - [x] Add `correlate_behavior_with_pnl(behavior_type: str, time_window: int) -> float` method
  - [x] Calculate correlation coefficients using numpy
  - [x] Identify behaviors most correlated with losses
  - [x] Store correlation results in database
  - [x] Create unit tests in `tests/unit/test_behavior_correlation.py`
- [x] Build weekly behavioral report generator (AC: 8)
  - [x] Create `genesis/analytics/behavioral_reports.py` for report generation
  - [x] Implement `WeeklyBehavioralReport` class
  - [x] Add `generate_weekly_report(profile_id: str, week_start: datetime) -> Report` method
  - [x] Include all behavioral metrics and trends
  - [x] Compare current week to baseline and previous weeks
  - [x] Generate actionable insights and recommendations
  - [x] Export report as structured JSON and human-readable text
  - [x] Create integration test in `tests/integration/test_behavioral_reporting.py`
- [x] Create database schema for behavioral data
  - [x] Add `behavioral_metrics` table to store all behavioral events
  - [x] Add `config_changes` table for configuration tracking
  - [x] Add `behavior_correlations` table for P&L correlations
  - [x] Create appropriate indexes for query performance
  - [x] Write migration script using Alembic
- [x] Integrate with existing tilt detection system
  - [x] Update `genesis/tilt/detector.py` to use new behavioral metrics
  - [x] Add behavioral anomalies to tilt score calculation
  - [x] Ensure real-time processing (<50ms latency requirement)
  - [x] Create integration test for end-to-end behavior tracking

## Dev Notes

### Architecture Context

**Technology Stack** [Source: architecture/tech-stack.md]
- Python 3.11.8 (no 3.12 features)
- pandas 2.2.0 for statistical calculations and analysis
- numpy 1.26.3 for correlation matrices and array operations
- decimal module for all financial calculations (NEVER use float for money)
- structlog 24.1.0 for structured logging (NEVER use print())
- pytest 8.0.0 with pytest-asyncio for testing
- SQLite with Alembic for database and migrations

**Project Structure** [Source: architecture/source-tree.md]
- Behavioral analytics code goes in `genesis/analytics/`
- Tilt indicators go in `genesis/tilt/indicators/`
- Tests follow structure: `tests/unit/test_{module}.py`
- Database models in `genesis/data/models_db.py`
- Repository pattern in `genesis/data/sqlite_repo.py`

**Coding Standards** [Source: architecture/coding-standards.md]
- Classes: PascalCase (e.g., `BehaviorAnalyzer`)
- Functions: snake_case (e.g., `track_click_latency`)
- Constants: UPPER_SNAKE (e.g., `MAX_LATENCY_MS`)
- Private methods: Leading underscore (e.g., `_calculate_baseline`)
- Time variables: Suffix with unit (e.g., `latency_ms`, `duration_seconds`)
- Type hints mandatory for all functions
- Use asyncio for all I/O operations
- Context managers for resource cleanup

**Data Models** [Source: architecture/data-models.md]

Relevant existing models:
- `TiltProfile`: Contains behavioral baseline metrics
  - `baseline_trades_per_hour`: Normal trading frequency
  - `baseline_click_latency_ms`: Normal decision speed
  - `baseline_cancel_rate`: Normal order cancellation rate
  - `current_tilt_score`: Current tilt level (0-100)

- `TiltEvent`: Records behavioral interventions
  - `tilt_indicators`: JSON array of triggered indicators
  - `tilt_score_before/after`: Score changes

- `TradingSession`: Groups trades for analysis
  - Can correlate with behavioral metrics

**Database Schema Additions** [Source: architecture/database-schema.md]

Need to add new tables following SQLite schema patterns:
```sql
CREATE TABLE IF NOT EXISTS behavioral_metrics (
    metric_id TEXT PRIMARY KEY,
    profile_id TEXT NOT NULL REFERENCES tilt_profiles(profile_id),
    session_id TEXT REFERENCES trading_sessions(session_id),
    metric_type TEXT NOT NULL,
    metric_value DECIMAL(20,8),
    metadata TEXT,  -- JSON for additional context
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS config_changes (
    change_id TEXT PRIMARY KEY,
    profile_id TEXT NOT NULL REFERENCES tilt_profiles(profile_id),
    setting_name TEXT NOT NULL,
    old_value TEXT,
    new_value TEXT,
    changed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

**Component Integration** [Source: architecture/components.md]

**Analytics Engine** responsibilities:
- Performance tracking, reporting, and forensic analysis
- Key interfaces:
  - `calculate_performance_metrics() -> PerformanceReport`
  - `analyze_tilt_correlation() -> TiltImpact`
- Technology: Python with pandas for analysis, structlog for forensics

**Tilt Detector** responsibilities:
- Real-time behavioral monitoring and psychological intervention
- Key interfaces:
  - `update_metrics(action: UserAction) -> TiltScore`
  - `calculate_baseline() -> BehavioralBaseline`
- Technology: Python with scipy for statistical analysis

### Previous Story Context

Story 3.3 implemented the intervention and recovery protocols. The behavioral analytics from this story (3.4) will feed into the tilt detection system created in story 3.2 and trigger the interventions from 3.3.

### Testing Requirements

**Testing Standards** [Source: architecture/test-strategy-and-standards.md]
- Framework: pytest 8.0.0 with pytest-asyncio
- File Convention: `test_{module}.py` in same structure as source
- Unit Tests Location: `tests/unit/`
- Integration Tests Location: `tests/integration/`
- Coverage Requirements: 90% for risk/tilt components
- Test Data: Use builder pattern and fixtures in `tests/fixtures/`
- Mocking: pytest-mock with faker for test data
- Database Testing: In-memory SQLite for speed

### Project Structure Notes

All new files align with the defined project structure. Behavioral analytics components will be created in `genesis/analytics/` directory, while tilt-specific indicators go in `genesis/tilt/indicators/`. The architecture clearly separates analytics from tilt detection, with analytics providing data that tilt detection consumes.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-25 | 1.0 | Initial story creation | Bob (SM) |
| 2025-08-25 | 1.1 | Implemented all behavioral analytics components | James (Dev) |
| 2025-08-25 | 1.2 | Completed database persistence tasks and QA fixes | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Linting fixed: ruff check with --fix applied
- Black formatting applied to all modified files
- All persistence methods added and tested

### Completion Notes List
1. Implemented comprehensive click-to-trade latency tracking with millisecond precision
2. Built order modification frequency monitoring with time-window analysis
3. Created tab-switching pattern detection for focus monitoring
4. Implemented "stare time" measurement for inactivity detection
5. Built configuration change tracking with stability scoring
6. Implemented session length analysis with fatigue detection
7. Created behavior-P&L correlation system with statistical analysis
8. Built weekly behavioral report generator with insights and recommendations
9. Extended database schema with new tables for behavioral data
10. Integrated all new behavioral metrics with existing tilt detection system
11. Ensured real-time processing performance under 50ms requirement
12. Created comprehensive unit and integration tests for all components
13. Added database persistence methods to SQLiteRepository for behavioral metrics, config changes, and behavior correlations
14. Updated all behavioral analytics modules to use repository pattern for persistence
15. Created Alembic migration script (004) for new behavioral analytics tables
16. Fixed all linting issues with ruff and black formatting
17. Ensured all datetime operations use timezone-aware UTC

### File List
- Created: genesis/analytics/behavioral_metrics.py
- Created: genesis/analytics/config_tracker.py
- Created: genesis/analytics/behavior_correlation.py
- Created: genesis/analytics/behavioral_reports.py
- Created: genesis/tilt/indicators/focus_patterns.py
- Created: tests/unit/test_behavioral_metrics.py
- Created: tests/unit/test_config_tracker.py
- Created: tests/unit/test_behavior_correlation.py
- Created: tests/unit/test_focus_patterns.py
- Created: tests/integration/test_behavioral_reporting.py
- Created: alembic/versions/004_add_behavioral_analytics_tables.py
- Modified: genesis/data/models_db.py
- Modified: genesis/data/sqlite_repo.py
- Modified: genesis/tilt/detector.py
- Modified: tests/integration/test_tilt_detection_workflow.py

## QA Results