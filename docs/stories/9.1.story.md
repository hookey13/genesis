# Story 9.1: Cryptographic Authentication System Overhaul

## Story Information
**Epic:** 9 - Critical Security & Infrastructure Hardening  
**Story ID:** 9.1  
**Priority:** Critical (P0)  
**Estimated Effort:** 8 hours  
**Dependencies:** None (blocking for all other stories)  
**Sub-Stories:** 9.1.1, 9.1.2, 9.1.3  

## User Story
As a security architect,  
I want to replace SHA256 password hashing with bcrypt and implement proper authentication,  
So that user credentials are cryptographically secure and immune to rainbow table attacks.

## Problem Statement
The current system uses SHA256 for password hashing, which is cryptographically insecure for password storage as it's vulnerable to rainbow table attacks and can be brute-forced. Additionally, there's no proper session management, two-factor authentication, or secure API key generation. This represents a critical security vulnerability that would fail any security audit and could result in immediate account compromise.

## Acceptance Criteria
1. Replace all SHA256 hashing with bcrypt (cost factor 12)
2. Implement secure session management with JWT tokens  
3. Add two-factor authentication (TOTP) for admin access
4. Password complexity requirements (min 12 chars, mixed case, numbers, symbols)
5. Account lockout after 5 failed attempts with exponential backoff
6. Secure password reset flow with time-limited tokens
7. API key generation with proper entropy (256 bits)
8. Session invalidation on password change
9. Audit logging for all authentication events
10. OWASP Authentication Cheat Sheet compliance

## Technical Implementation Details

### Core Components
```python
# New files to create:
# genesis/security/auth_manager.py - Main authentication manager
# genesis/security/password_policy.py - Password policy enforcement
# genesis/security/session_manager.py - JWT session management  
# genesis/security/api_key_manager.py - API key generation and validation
# genesis/security/audit_logger.py - Authentication event logging
```

### Files to Modify
- `genesis/api/auth.py` - Update authentication endpoints
- `genesis/models/user.py` - Update user model for bcrypt hashes
- `genesis/database/schema.py` - Add new auth-related tables
- `tests/unit/test_auth.py` - Update authentication tests
- `requirements.txt` - Add bcrypt, PyJWT, pyotp dependencies

### Configuration Changes
```python
# config/auth_config.py
AUTH_CONFIG = {
    'bcrypt_rounds': 12,
    'jwt_secret': None,  # Load from Vault
    'jwt_algorithm': 'HS256',
    'session_ttl_seconds': 3600,
    'max_login_attempts': 5,
    'lockout_duration_seconds': 900,
    'password_min_length': 12,
    'require_2fa_for_admin': True,
    'api_key_length_bytes': 32
}
```

### Database Schema Updates
```sql
-- Add authentication tables
CREATE TABLE user_sessions (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    token_id VARCHAR(32) UNIQUE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ NOT NULL,
    is_active BOOLEAN DEFAULT true,
    user_agent TEXT,
    ip_address INET
);

CREATE TABLE login_attempts (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(255) NOT NULL,
    ip_address INET NOT NULL,
    success BOOLEAN NOT NULL,
    attempted_at TIMESTAMPTZ DEFAULT NOW(),
    user_agent TEXT,
    failure_reason VARCHAR(100)
);

CREATE TABLE user_2fa (
    user_id BIGINT PRIMARY KEY,
    secret VARCHAR(32) NOT NULL,
    enabled BOOLEAN DEFAULT false,
    backup_codes TEXT[],
    created_at TIMESTAMPTZ DEFAULT NOW(),
    last_used_at TIMESTAMPTZ
);

CREATE TABLE api_keys (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    key_id VARCHAR(32) UNIQUE NOT NULL,
    key_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100),
    permissions TEXT[],
    created_at TIMESTAMPTZ DEFAULT NOW(),
    last_used_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,
    is_active BOOLEAN DEFAULT true
);
```

## Implementation Checklist

### Phase 1: Password Security Foundation (2 hours)
- [ ] Install and configure bcrypt dependency
- [ ] Create SecureAuthManager class with bcrypt hashing
- [ ] Implement password complexity validation
- [ ] Create migration script for existing password hashes
- [ ] Add password history tracking to prevent reuse
- [ ] Unit tests for password hashing and validation

### Phase 2: Session Management (2 hours)  
- [ ] Implement JWT-based session management
- [ ] Create secure token generation and validation
- [ ] Add session storage and cleanup mechanisms
- [ ] Implement token refresh functionality
- [ ] Session invalidation on password change
- [ ] Unit tests for session management

### Phase 3: Account Security (2 hours)
- [ ] Implement login attempt tracking
- [ ] Add account lockout with exponential backoff
- [ ] Create secure password reset flow
- [ ] Rate limiting for authentication endpoints
- [ ] IP-based blocking for suspicious activity
- [ ] Integration tests for security features

### Phase 4: API Key System (2 hours)
- [ ] Implement cryptographically secure API key generation
- [ ] Create API key validation and permissions system
- [ ] Add API key management endpoints
- [ ] Implement API key rotation capabilities
- [ ] Audit logging for API key usage
- [ ] Load tests for API key authentication

## Testing Requirements

### Unit Tests
- [ ] Password hashing with bcrypt (100% coverage)
- [ ] Password complexity validation edge cases
- [ ] JWT token generation and validation
- [ ] Account lockout logic with various scenarios
- [ ] API key generation entropy testing
- [ ] Session management lifecycle tests

### Integration Tests  
- [ ] Complete authentication flow testing
- [ ] Password reset end-to-end flow
- [ ] Account lockout and unlock scenarios
- [ ] API key authentication with real requests
- [ ] Session expiration and refresh testing
- [ ] Cross-browser session management

### Security Tests
- [ ] Brute force attack simulation
- [ ] Rainbow table attack resistance verification
- [ ] JWT token manipulation attempts
- [ ] Session hijacking prevention testing
- [ ] API key enumeration attack prevention
- [ ] Password reset token security validation

### Performance Tests
- [ ] Bcrypt performance with cost factor 12
- [ ] Concurrent authentication load testing
- [ ] Session lookup performance under load
- [ ] API key validation latency testing
- [ ] Memory usage during authentication spikes

## Dependencies
- **Blocks:** All other Epic 9 stories (critical security foundation)
- **External:** HashiCorp Vault (Story 9.3) for JWT secret storage
- **Internal:** Database migration framework

## Definition of Done
- [ ] All SHA256 password hashing removed from codebase
- [ ] Bcrypt with cost factor 12 implemented for all passwords  
- [ ] JWT-based session management fully operational
- [ ] Account lockout mechanism prevents brute force attacks
- [ ] API keys generated with 256-bit entropy
- [ ] All authentication events logged for audit
- [ ] 100% test coverage for security-critical functions
- [ ] Security audit checklist completed
- [ ] OWASP Authentication requirements validated
- [ ] Performance meets <50ms latency requirement
- [ ] Documentation updated with new security procedures
- [ ] Emergency account recovery procedures documented

## Risk Mitigation
- **Password Migration Risk:** Implement gradual migration with fallback to old hashes during transition
- **Session Disruption:** Implement graceful session migration for existing users
- **Performance Impact:** Monitor bcrypt performance and adjust cost factor if needed
- **Security Regression:** Comprehensive security testing before deployment
- **Lockout Risk:** Implement admin override for account unlocking

## Success Metrics
- Zero instances of SHA256 password hashing in production
- <1% false positive rate for account lockouts
- 100% successful migration of existing user passwords
- <50ms authentication response time at 99th percentile
- Zero authentication bypass vulnerabilities in security scan
- 100% OWASP Authentication Cheat Sheet compliance

## Notes
This is a **CRITICAL SECURITY** story that must be completed before any production deployment. The current SHA256 password hashing is cryptographically broken and represents an immediate security risk. This story is blocking for all other Epic 9 work as it establishes the security foundation the entire system depends on.

Priority order within story:
1. Bcrypt password hashing (highest priority - fixes critical vulnerability)
2. Session management (required for secure operations)  
3. Account security features (prevents brute force attacks)
4. API key system (enables secure programmatic access)