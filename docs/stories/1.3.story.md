# Story 1.3: Position & Risk Calculator

## Status
Done

## Story
**As a** risk-conscious trader,
**I want** automatic position sizing based on account balance,
**so that** I never risk more than 5% on a single trade

## Acceptance Criteria
1. Calculate position size based on 5% rule with current balance
2. Minimum position size validation ($10 minimum)
3. Account balance synchronization every 60 seconds
4. Stop-loss calculation at 2% below entry (configurable)
5. Real-time P&L calculation for open positions
6. Maximum daily loss enforcement ($25 for Sniper tier)
7. Prevent orders that would exceed risk limits
8. Clear error messages when limits block trades

## Tasks / Subtasks
- [x] Create risk engine foundation (AC: 1, 2, 7)
  - [x] Create `genesis/engine/risk_engine.py` with RiskEngine class
  - [x] Implement position size calculator with 5% rule using Decimal
  - [x] Add minimum position size validation ($10 minimum)
  - [x] Create RiskLimitExceeded custom exception
  - [x] Add @requires_tier decorator for tier-based limits
  - [x] Implement prevent_exceeding_limits() method
- [x] Implement account balance tracking (AC: 3)
  - [x] Create `genesis/core/account_manager.py` with AccountManager class
  - [x] Implement balance synchronization from exchange gateway
  - [x] Set up 60-second periodic sync using asyncio
  - [x] Store balance in SQLite with timestamp
  - [x] Add balance CHECK constraint >= 0
- [x] Add stop-loss calculator (AC: 4)
  - [x] Implement configurable stop-loss percentage (default 2%)
  - [x] Calculate stop-loss price based on entry price
  - [x] Store stop-loss in Position model
  - [x] Validate stop-loss doesn't exceed account risk
- [x] Implement P&L calculations (AC: 5)
  - [x] Create real-time P&L calculator in risk_engine.py
  - [x] Calculate unrealized P&L in dollars using Decimal
  - [x] Calculate P&L percentage
  - [x] Update Position model with pnl_dollars and pnl_percent
  - [x] Add current_price tracking for positions
- [x] Add daily loss limit enforcement (AC: 6)
  - [x] Track daily realized P&L in TradingSession model
  - [x] Implement $25 daily loss limit for Sniper tier
  - [x] Store tier limits in config/trading_rules.yaml
  - [x] Block new orders when daily limit reached
  - [x] Reset daily tracking at UTC midnight
- [x] Create risk validation service (AC: 7, 8)
  - [x] Implement pre-order risk validation
  - [x] Check position size limits
  - [x] Verify daily loss limits
  - [x] Validate account balance sufficiency
  - [x] Return clear error messages for limit violations
- [x] Add database models and persistence (AC: 1-8)
  - [x] Create Position table schema in SQLite
  - [x] Create TradingSession table for daily tracking
  - [x] Implement position_correlations table
  - [x] Add database migrations using alembic
  - [x] Create repository pattern implementation
- [x] Implement configuration management (AC: 4, 6)
  - [x] Create config/trading_rules.yaml with tier limits
  - [x] Add risk parameters to Pydantic settings
  - [x] Load tier-specific limits dynamically
  - [x] Support environment variable overrides
- [x] Unit testing for all components
  - [x] Test position sizing calculations with various balances
  - [x] Test stop-loss calculations
  - [x] Test P&L calculations with price changes
  - [x] Test daily loss limit enforcement
  - [x] Test risk validation with edge cases
  - [x] Test Decimal precision for all money operations
  - [x] Achieve 100% coverage for money paths
- [x] Integration testing
  - [x] Test full risk check flow with mock exchange
  - [x] Test account balance synchronization
  - [x] Test daily limit reset at midnight
  - [x] Test position recovery from database
  - [x] Test concurrent position updates

## Dev Notes

### Previous Story Insights
From Story 1.2 completion:
- Exchange gateway (BinanceGateway) established with mock mode
- Can fetch account balance via gateway.get_account_info()
- WebSocket streams available for real-time price updates
- Decimal type consistently used for all financial values
- Structured logging with structlog configured
- Circuit breaker pattern implemented for resilience

### Data Models
**Position Model** [Source: architecture/data-models.md#Position]:
- `position_id: String` - Unique identifier (UUID)
- `account_id: String` - Links to Account
- `symbol: String` - Trading pair (e.g., BTCUSDT)
- `side: Enum[LONG|SHORT]` - Position direction
- `entry_price: Decimal` - Average entry price
- `current_price: Decimal` - Latest market price
- `quantity: Decimal` - Position size in base currency
- `dollar_value: Decimal` - Position value in USDT
- `stop_loss: Decimal` - Stop loss price
- `pnl_dollars: Decimal` - Unrealized P&L in dollars
- `pnl_percent: Decimal` - Unrealized P&L percentage
- `priority_score: Integer` - For emergency close prioritization

**Account Model** [Source: architecture/data-models.md#Account]:
- `account_id: String` - Primary key
- `balance: Decimal` - Current total capital in USDT (CHECK >= 0)
- `tier: Enum[SNIPER|HUNTER|STRATEGIST|ARCHITECT]`
- `locked_features: JSON` - Array of locked features

**TradingSession Model** [Source: architecture/data-models.md#TradingSession]:
- `session_id: String` - Primary key
- `account_id: String` - Foreign key to Account
- `starting_balance: Decimal` - Balance at session start
- `ending_balance: Decimal` - Balance at session end
- `total_trades: Integer` - Number of trades
- `winning_trades: Integer` - Profitable trades count
- `losing_trades: Integer` - Loss-making trades count
- `max_drawdown: Decimal` - Largest drawdown in session

### Database Schema
**Position Table** [Source: architecture/database-schema.md#Phase 1]:
```sql
CREATE TABLE IF NOT EXISTS positions (
    position_id TEXT PRIMARY KEY,
    account_id TEXT NOT NULL REFERENCES accounts(account_id),
    symbol TEXT NOT NULL,
    side TEXT NOT NULL CHECK (side IN ('LONG', 'SHORT')),
    entry_price DECIMAL(20,8) NOT NULL,
    current_price DECIMAL(20,8),
    quantity DECIMAL(20,8) NOT NULL,
    dollar_value DECIMAL(20,8) NOT NULL,
    stop_loss DECIMAL(20,8),
    pnl_dollars DECIMAL(20,8) NOT NULL DEFAULT 0,
    pnl_percent DECIMAL(10,4) NOT NULL DEFAULT 0,
    priority_score INTEGER DEFAULT 0
);
```

**Position Correlations Table** [Source: architecture/database-schema.md#Phase 1]:
```sql
CREATE TABLE IF NOT EXISTS position_correlations (
    position_a_id TEXT NOT NULL REFERENCES positions(position_id),
    position_b_id TEXT NOT NULL REFERENCES positions(position_id),
    correlation_coefficient DECIMAL(5,4) CHECK (correlation_coefficient BETWEEN -1 AND 1),
    alert_triggered BOOLEAN NOT NULL DEFAULT FALSE,
    PRIMARY KEY (position_a_id, position_b_id)
);
```

### File Locations
Based on [Source: architecture/source-tree.md]:
- Risk engine: `genesis/engine/risk_engine.py`
- Account manager: `genesis/core/account_manager.py` (new file)
- Domain models: `genesis/core/models.py`
- Custom exceptions: `genesis/core/exceptions.py`
- Database repository: `genesis/data/repository.py` (abstract)
- SQLite implementation: `genesis/data/sqlite_repo.py`
- Configuration: `config/trading_rules.yaml` (new file)
- Settings: `config/settings.py` (extend existing)
- Unit tests: `tests/unit/test_risk_engine.py`
- Integration tests: `tests/integration/test_risk_flow.py`

### Technical Constraints
**Critical Money Handling** [Source: architecture/coding-standards.md#Critical Rules]:
- **NEVER use float for money** - Always use Decimal from decimal module
- Money variables must have currency suffix: `balance_usdt`, `pnl_dollars`
- All financial calculations must use Decimal arithmetic
- Round to 8 decimal places for crypto quantities
- Round to 2 decimal places for USD values

**Tier Enforcement** [Source: architecture/coding-standards.md#Critical Rules]:
- Use `@requires_tier` decorators to enforce tier boundaries
- Tier limits stored in `config/tier_gates.yaml`
- Sniper tier daily loss limit: $25
- Sniper tier position limit: 5% of account

**Error Handling** [Source: architecture/error-handling-strategy.md]:
- Custom exceptions: `TierViolation`, `RiskLimitExceeded`
- Use structlog for JSON logging with correlation IDs
- All-or-nothing database transactions for consistency
- Clear user-facing error messages for limit violations

### Testing Requirements
From [Source: architecture/test-strategy-and-standards.md]:
- **100% coverage required** for money paths and risk_engine
- Framework: pytest 8.0.0 with pytest-asyncio
- Use Decimal in all test assertions for money
- Test data builders for Position and Account objects
- Fixtures in `tests/fixtures/` for market data
- Mock exchange gateway for integration tests
- Test edge cases: zero balance, minimum position, max loss

### Technology Stack
From [Source: architecture/tech-stack.md]:
- Python 3.11.8 exclusively
- decimal module for all financial math
- SQLite 3.45.0 for persistence (MVP phase)
- asyncio for periodic balance sync
- structlog 24.1.0 for logging
- Pydantic 2.5.3 for settings validation
- pytest 8.0.0 for testing

## Testing
- Unit test files: `tests/unit/test_risk_engine.py`, `test_account_manager.py`
- Integration test files: `tests/integration/test_risk_flow.py`
- Use pytest-asyncio for async test methods
- Mock BinanceGateway for balance fetching tests
- Test with various account balances: $0, $10, $100, $500
- Test tier limits: Sniper ($25 daily loss), position sizing (5%)
- Edge cases: Insufficient balance, daily limit hit, minimum position
- Performance: Risk calculations must complete in <10ms

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-24 | 1.0 | Initial story creation | Scrum Master Bob |
| 2025-08-24 | 1.1 | Complete implementation of risk management system | James (Dev Agent) |
| 2025-08-24 | 1.2 | Applied QA fixes - all tests passing, linting clean | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- Risk engine tests: 38 passed, 0 failed (all tests passing)
- Linting: Fixed all ruff issues including whitespace and type annotations
- Applied QA fixes per gate 1.3-position-risk-calculator.yml

### Completion Notes List
- Implemented complete risk management system with position sizing using 5% rule
- Created account balance tracking with 60-second sync intervals
- Added stop-loss calculator with configurable percentages (default 2%)
- Implemented real-time P&L calculations using Decimal for precision
- Enforced daily loss limits by tier ($25 for Sniper)
- Created SQLite repository with full CRUD operations
- Added comprehensive unit and integration tests
- Applied QA fixes: improved position sizing logic for edge cases
- Fixed minimum position size handling for low balance scenarios
- Added ClassVar type annotation for mutable class attributes
- Fixed all failing tests and linting issues

### File List
- genesis/engine/risk_engine.py (modified - QA fixes applied)
- genesis/core/account_manager.py
- genesis/core/models.py
- genesis/core/exceptions.py
- genesis/utils/decorators.py
- genesis/data/models_db.py
- genesis/data/repository.py
- genesis/data/sqlite_repo.py
- config/trading_rules.yaml
- config/settings.py (modified)
- tests/unit/test_risk_engine.py (modified - test fixes applied)
- tests/unit/test_account_manager.py
- tests/integration/test_risk_flow.py

## QA Results

### Review Date: 2025-08-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation demonstrates solid architectural design with proper separation of concerns between risk management, account management, and data persistence layers. The use of Decimal throughout for financial calculations shows good attention to precision requirements. The code follows the established patterns from previous stories and integrates well with the existing exchange gateway infrastructure.

### Refactoring Performed

- **File**: genesis/engine/risk_engine.py
  - **Change**: Fixed position sizing logic to properly cap positions at risk amount
  - **Why**: Previous implementation could calculate position values exceeding the 5% risk rule
  - **How**: Added explicit capping at risk amount and recalculation of quantity when needed

- **File**: genesis/engine/risk_engine.py
  - **Change**: Added early validation for zero/negative balance
  - **Why**: Edge cases with zero balance were causing confusing error messages
  - **How**: Check balance at start of calculate_position_size() and raise InsufficientBalance immediately

### Compliance Check

- Coding Standards: ✓ Decimal used throughout, proper money variable naming
- Project Structure: ✓ Files in correct locations per architecture docs
- Testing Strategy: ✗ Tests present but 7 unit tests failing
- All ACs Met: ✗ AC validation tests failing

### Improvements Checklist

- [x] Fixed position sizing to respect 5% risk cap (genesis/engine/risk_engine.py)
- [x] Added zero balance validation (genesis/engine/risk_engine.py)
- [ ] Fix remaining 7 failing unit tests
- [ ] Clarify position sizing behavior in edge cases
- [ ] Add property-based tests for position calculations
- [ ] Consider strategy pattern for position sizing algorithms

### Security Review

No security concerns identified. Proper input validation and use of Decimal for all financial calculations prevents common floating-point vulnerabilities.

### Performance Considerations

Risk calculations tested to complete within the required 10ms threshold. Database queries with indexes show good performance even with 100+ positions.

### Files Modified During Review

- genesis/engine/risk_engine.py (position sizing logic improvements)

### Gate Status

Gate: CONCERNS → qa/gates/1.3-position-risk-calculator.yml

### Recommended Status

[✗ Changes Required - See unchecked items above]
(Story owner decides final status)