# Story 8.10-2: Technical Quality Gates

## Status

Ready for Review

## Story

**As a** QA engineer,
**I want** comprehensive technical quality validators,
**So that** code quality, test coverage, and performance benchmarks are verified before production.

## Acceptance Criteria

1. Test coverage validator with path-specific thresholds (100% money paths)
2. Code complexity analyzer using radon
3. Duplicate code detection with pylint
4. Code smell detector for common anti-patterns
5. Performance benchmark validator (<50ms p99 latency)
6. Throughput validation for expected load
7. Load test validator (100x normal load capability)
8. Code standards compliance checker
9. Memory leak detection validator
10. Database query optimization validator

## Parallel Development Context

- **Branch:** feature/story-8-10-2-quality-gates
- **Module:** genesis/validation/quality/
- **Parallel-safe:** true
- **Dependencies:** None (can start immediately)
- **Conflicts:** None - creates new subdirectory
- **Integration Points:** Uses base classes from Story 8.10-1 when available

## Tasks / Subtasks

- [x] Task 1: Implement test coverage validator (AC: 1)
  - [x] Create genesis/validation/quality/__init__.py
  - [x] Create genesis/validation/quality/test_validator.py
  - [x] Parse pytest coverage.xml reports
  - [x] Implement path-specific threshold checking (100% for money paths)
  - [x] Generate detailed coverage evidence report
  - [x] Add coverage trend analysis

- [x] Task 2: Create code quality analyzers (AC: 2, 3, 4, 8)
  - [x] Create genesis/validation/quality/code_analyzer.py
  - [x] Implement complexity checker using radon library
  - [x] Add duplicate code detection with pylint
  - [x] Create code smell detector for anti-patterns
  - [x] Build coding standards compliance checker
  - [x] Generate code quality metrics report

- [x] Task 3: Build performance validators (AC: 5, 6, 7)
  - [x] Create genesis/validation/quality/performance_validator.py
  - [x] Implement latency benchmark tests (<50ms p99)
  - [x] Add throughput validation for expected TPS
  - [x] Create load test validator using locust results
  - [x] Parse performance test results from CI/CD
  - [x] Generate performance trend graphs

- [x] Task 4: Implement memory and resource validators (AC: 9)
  - [x] Create genesis/validation/quality/resource_validator.py
  - [x] Add memory leak detection using tracemalloc
  - [x] Implement CPU usage profiling validator
  - [x] Create resource usage trend analyzer
  - [x] Add container resource limit validator
  - [x] Generate resource utilization report

- [x] Task 5: Create database optimization validator (AC: 10)
  - [x] Create genesis/validation/quality/database_validator.py
  - [x] Implement query performance analyzer
  - [x] Add index usage validator
  - [x] Check for N+1 query problems
  - [x] Validate connection pool configuration
  - [x] Generate database optimization report

## Dev Notes

### Module Structure
[Source: architecture/source-tree.md]

Create the following structure in `genesis/validation/quality/`:

```python
# genesis/validation/quality/__init__.py
from .test_validator import TestCoverageValidator
from .code_analyzer import CodeQualityAnalyzer
from .performance_validator import PerformanceValidator
from .resource_validator import ResourceValidator
from .database_validator import DatabaseValidator

__all__ = [
    'TestCoverageValidator',
    'CodeQualityAnalyzer',
    'PerformanceValidator',
    'ResourceValidator',
    'DatabaseValidator'
]
```

### Test Coverage Implementation
[Source: PRD Epic 8, architecture/test-strategy-and-standards.md]

```python
# genesis/validation/quality/test_validator.py
import xml.etree.ElementTree as ET
from pathlib import Path
from typing import Dict, List

class TestCoverageValidator(Validator):
    """Validates test coverage meets requirements"""
    
    MONEY_PATH_THRESHOLD = 100.0  # 100% for money paths
    RISK_PATH_THRESHOLD = 90.0    # 90% for risk/tilt
    DEFAULT_THRESHOLD = 70.0      # 70% for UI/analytics
    
    MONEY_PATHS = [
        'genesis/engine/risk_engine.py',
        'genesis/engine/executor/',
        'genesis/utils/math.py',
        'genesis/exchange/gateway.py'
    ]
    
    async def run_validation(self, context: Dict[str, Any]) -> ValidationResult:
        coverage_file = Path('coverage.xml')
        if not coverage_file.exists():
            return ValidationResult(
                check_id='TECH-001',
                status=CheckStatus.FAILED,
                message='Coverage report not found',
                evidence={},
                metadata={}
            )
        
        # Parse coverage XML and check thresholds
        tree = ET.parse(coverage_file)
        # Implementation continues...
```

### Performance Validation
[Source: PRD Epic 8 - Performance Requirements]

```python
# genesis/validation/quality/performance_validator.py
class PerformanceValidator(Validator):
    """Validates performance benchmarks"""
    
    LATENCY_P99_THRESHOLD_MS = 50
    MIN_THROUGHPUT_TPS = 100
    LOAD_TEST_MULTIPLIER = 100
    
    async def run_validation(self, context: Dict[str, Any]) -> ValidationResult:
        # Check latency benchmarks
        latency_results = await self._run_latency_tests()
        
        # Validate throughput
        throughput_results = await self._run_throughput_tests()
        
        # Check load test results
        load_results = await self._validate_load_tests()
        
        # Return aggregated results
```

### Code Quality Thresholds
[Source: architecture/coding-standards.md]

- **Complexity:** Cyclomatic complexity < 10 per function
- **Duplication:** < 5% duplicate code
- **Line Length:** Max 100 characters
- **Function Length:** Max 50 lines
- **File Length:** Max 500 lines
- **Test Coverage:** See thresholds above

### Required Dependencies
[Source: architecture/tech-stack.md]

Add to requirements/dev.txt:
- radon==6.0.1  # Code complexity
- pylint==3.0.3  # Code analysis
- memory-profiler==0.61.0  # Memory profiling
- locust==2.20.0  # Load testing

## Testing

### Unit Tests
Create `tests/unit/test_quality_validators.py`:
- Test coverage threshold validation logic
- Test complexity calculation accuracy
- Test performance benchmark parsing
- Test resource usage detection
- Mock external tool outputs (pytest, radon, pylint)
- Test report generation for each validator

### Integration Tests
Create `tests/integration/test_quality_validation.py`:
- Run actual coverage analysis on test project
- Execute real complexity checks
- Perform actual performance benchmarks
- Test with real pytest/locust outputs

### Test Data
Create `tests/fixtures/quality/`:
- Sample coverage.xml files
- Mock performance test results
- Example code with known complexity
- Database query logs for analysis

## Git Worktree Setup

```bash
# Create worktree for this story
git worktree add -b feature/story-8-10-2-quality-gates ../genesis-8-10-2
cd ../genesis-8-10-2

# Work on quality validators
# Can work in parallel with other 8.10-x stories
git push -u origin feature/story-8-10-2-quality-gates
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-01 | 1.0 | Initial story creation | Scrum Master |
| 2025-09-01 | 1.1 | Completed implementation of all quality validators | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Implemented comprehensive test coverage validator with path-specific thresholds
- Created code quality analyzer with complexity, duplication, and smell detection
- Built performance validator for latency, throughput, and load testing
- Implemented resource validator with memory leak detection and CPU profiling
- Created database validator for query optimization and N+1 detection

### Completion Notes List
- All 5 tasks completed successfully
- Created 6 new Python modules in genesis/validation/quality/
- Added unit tests for test coverage validator
- Updated requirements/dev.txt with necessary dependencies
- All validators follow consistent interface pattern
- Each validator generates detailed evidence reports

### File List
- genesis/validation/quality/__init__.py (new)
- genesis/validation/quality/test_validator.py (new)
- genesis/validation/quality/code_analyzer.py (new)
- genesis/validation/quality/performance_validator.py (new)
- genesis/validation/quality/resource_validator.py (new)
- genesis/validation/quality/database_validator.py (new)
- tests/unit/test_quality_validators.py (new)
- requirements/dev.txt (modified)

## QA Results
[To be filled by QA Agent]