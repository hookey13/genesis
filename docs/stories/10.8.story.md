# Story 10.8: Paper Trading & Strategy Validation

**Status:** Approved
**Epic:** Epic 10 - Core Trading Brain Implementation
**Type:** Sequential-Required (Needs engine)
**Branch:** feature/10-8
**Estimated Hours:** 8
**Developer Assignment:** Developer 4

## User Story
As a risk manager,
I want a paper trading mode that validates strategies with simulated execution,
So that new strategies can be tested in live market conditions without capital risk.

## Acceptance Criteria
1. Parallel paper trading alongside live trading
2. Simulated order execution with realistic fills
3. Virtual portfolio tracking
4. Side-by-side performance comparison
5. Automatic promotion to live trading after validation
6. Configurable validation criteria (min trades, min days, min Sharpe)
7. A/B testing framework for strategy variants
8. Gradual capital allocation for validated strategies
9. Performance regression detection
10. Audit trail for strategy promotion decisions

## Technical Implementation

### Files to Modify/Create
```
├── genesis/
│   ├── paper_trading/
│   │   ├── __init__.py [CREATE]
│   │   ├── simulator.py [CREATE]
│   │   ├── virtual_portfolio.py [CREATE]
│   │   ├── promotion_manager.py [CREATE]
│   │   └── validation_criteria.py [CREATE]
└── tests/
    └── integration/
        └── test_paper_trading.py [MODIFY/CREATE]
```

### Code Modules Owned
- **Primary:** All paper trading modules
- **No Touch:** Live trading engine, strategies

## Dependencies

### Must Complete Before Starting
- Story 10.5 (Trading Engine)
- Story 10.7 (Performance Monitoring)

### Can Start But Needs Later
- None

### Parallel Stories (Same Time)
- Story 10.9 (Config Management)

## Implementation Checklist
- [ ] Create feature branch via worktree
- [ ] Create PaperTradingSimulator
- [ ] Implement SimulatedExecutor
- [ ] Create VirtualPortfolio
- [ ] Add ValidationCriteria class
- [ ] Implement StrategyPromotionManager
- [ ] Add A/B testing framework
- [ ] Create gradual allocation logic
- [ ] Add regression detection
- [ ] Implement audit trail
- [ ] Write integration tests
- [ ] Test promotion logic
- [ ] Create pull request
- [ ] Peer review from Story 10.7 developer
- [ ] Merge to main branch

## Worktree Setup Commands
```bash
# Developer 4 executes:
cd /path/to/main/repo
git worktree add -b feature/10-8 ../worktree-10-8
cd ../worktree-10-8

# After completion:
git push origin feature/10-8
# Create PR for review
```

## Testing Requirements
### Integration Tests
- Paper trading simulation
- Promotion criteria validation
- A/B test scenarios
- Regression detection accuracy

### Validation Tests
- 7-day paper trading run
- Performance comparison with live

## Definition of Done
- [ ] All acceptance criteria met
- [ ] Code review approved
- [ ] All tests passing
- [ ] Promotion logic validated
- [ ] Audit trail working
- [ ] Documentation complete
- [ ] Branch merged to main

## Dev Notes

### Testing Standards
- **Test file location:** `tests/integration/test_paper_trading.py` (modify existing file)
- **Test framework:** pytest with async support (pytest-asyncio)
- **Coverage requirement:** >90% for all paper trading modules
- **Test scenarios:** Must include promotion logic, A/B testing, regression detection
- **Validation tests:** 7-day paper trading simulation required
- **Mock data:** Use realistic market conditions from historical data

### Project Structure
From the source tree, new paper trading modules:
```
genesis/
├── paper_trading/              # NEW DIRECTORY
│   ├── __init__.py
│   ├── simulator.py           # Main paper trading simulator
│   ├── virtual_portfolio.py   # Virtual portfolio tracking
│   ├── promotion_manager.py   # Strategy promotion logic
│   └── validation_criteria.py # Validation rules
├── engine/                     # EXISTING - integrate with
│   ├── engine.py              # Trading engine
│   └── executor/              # Execution modules
└── strategies/                 # EXISTING strategies to test
```

### Architecture Context
- **Python version:** 3.11.8 (no 3.12 features)
- **Async framework:** asyncio for all concurrent operations
- **Decimal math:** Use decimal.Decimal for all money calculations
- **Logging:** structlog for structured logging with audit trail
- **Database:** SQLite for paper trading results, migrate to PostgreSQL at $2k+
- **Type hints:** Mandatory for all function signatures

### Integration Requirements
- Must run parallel to live trading without interference
- Must integrate with existing `genesis/engine/engine.py`
- Must use same market data feed as live trading
- Must respect tier-based position limits from configuration
- Must integrate with `genesis/monitoring/strategy_monitor.py` from Story 10.7
- Audit trail must be persisted to database with timestamps

### Key Implementation Details

#### PaperTradingSimulator Class
- **Parallel execution:** Run alongside live trading using separate portfolio
- **Simulated fills:** Add realistic slippage (2-5 bps) and latency (5-15ms)
- **Virtual portfolio:** Track positions, P&L, and performance metrics
- **State persistence:** Save state to database for recovery

#### SimulatedExecutor
- **Order simulation:** Process orders with realistic market impact
- **Latency simulation:** Add random.gauss(10, 2) ms latency
- **Slippage model:** Apply random.gauss(2, 1) basis points slippage
- **Partial fills:** Simulate partial fills for large orders

#### VirtualPortfolio
- **Position tracking:** Maintain virtual positions separate from live
- **P&L calculation:** Real-time mark-to-market valuation
- **Performance metrics:** Calculate Sharpe, win rate, profit factor
- **Risk metrics:** Track drawdown, VaR, exposure

#### ValidationCriteria
- **Minimum trades:** Configurable (default: 100 trades)
- **Minimum days:** Configurable (default: 7 days)
- **Minimum Sharpe:** Configurable (default: 1.5)
- **Maximum drawdown:** Configurable (default: 10%)
- **Win rate threshold:** Configurable (default: 55%)

#### StrategyPromotionManager
- **Automatic promotion:** Promote when all criteria met
- **Gradual allocation:** Start with 10% capital, increase gradually
- **A/B testing:** Support multiple parameter sets simultaneously
- **Regression detection:** Monitor for performance degradation
- **Rollback capability:** Demote strategies if performance drops

### Configuration Example
```yaml
paper_trading:
  enabled: true
  validation_criteria:
    min_trades: 100
    min_days: 7
    min_sharpe: 1.5
    max_drawdown: 0.10
    min_win_rate: 0.55
  promotion:
    auto_promote: true
    initial_allocation: 0.10
    allocation_increment: 0.10
    max_allocation: 1.00
  ab_testing:
    enabled: true
    max_variants: 3
```

### Critical Performance Requirements
- Simulation overhead: <5% CPU increase
- Memory usage: <50MB per simulated strategy
- Promotion decision latency: <1 second
- Audit log write latency: <10ms

### Audit Trail Requirements
- Log all paper trades with timestamps
- Record promotion decisions with criteria values
- Track parameter changes and A/B test results
- Store performance metrics at regular intervals
- Maintain complete history for compliance

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-03 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-09-03 | 1.1 | Added Dev Notes and implementation details | Sarah (PO) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*TBD*

### Debug Log References
*TBD*

### Completion Notes List
*TBD*

### File List
*TBD*

## QA Results
*To be populated during QA review*